## General
MONICA uses a couple of configuration files to either parameterize the model or setup all input data necessary to run the model. Necessary to run the model are four files, ending in:

 - **climate.csv**
 - **sim.json**
 - **site.json**
 - **crop.json**

The three .json files contain the necessary input information to run the MONICA model. These files currently follow the philosophy that these three files should contain and reflect ALL information the model needs to run. Optionally these three files can reference other .json files which contain actual parameters to the MONICA model (crop, general soil or general environmental parameters). Instead of the .json parameter files all necessary data can also be got from a SQLite database. Either way (file or database) every one of the three .json files (sim/site/crop.json) will end up holding (at runtime) all information MONICA needs to run. Because of that it's also possible instead of referencing other parameter files or database data, to include all parameters manually into on of the three files. This makes especially sense if these files are being generated by some external tool for bulk processing.

All **.json** configuration files reflect to some degree the data structures being used internally in MONICA. If MONICA won't find a value in a configuration file a hard-coded default value will be used. These can usually be taken from the corresponding .h (C++ header file) in the MONICA sources. Real parameters to the MONICA model should all have default values. In contrast missing input data (like start and end date in **sim.json**) can't be compensated for and MONICA won't run.

In the following json code snippet two settings are being declared (taken from the **sim.json** example file), **UseAutomaticIrrigation** which is set to **false** and **AutoIrrigationParams** which is set to a **JSON object** (key/value map). This object/map is contains itself three parameters. **irrigationParameters** is once more a JSON object, while **amount** is set to a **JSON array** (list of values) **[17, "mm"]** and **threshold** is set to the **double** value **0.35**. **amount** is interesting because MONICA allows in place of a simple value like **17** a JSON array, with two or three elements. The second element (in this case **"mm"**) will be treated as the unit describing the value (**17**) and an optional third value might act as a description for the value, in case the values unit won't be self-describing enough. 

> **Note:** Even though one can use the JSON array syntax to add **units of measure** and an optional description, this is **currently ignored** by MONICA. The user has still to refer to the MONICA documentation (or the example files) to enter values using the right units of measure and dimensions.

```
"UseAutomaticIrrigation": false,  
"AutoIrrigationParams": {
  "irrigationParameters": {
    "nitrateConcentration": [0, "mg dm-3"],
    "sulfateConcentration": [0, "mg dm-3"]
  },
  "amount": [17, "mm"],
  "threshold": 0.35
},  
```

One can either include all necessary data (potentially deeply nested JSON objects) into the configuration files or use a reference and include mechanism to fetch data from a SQLite database or files in the filesystem. Where applicable (e.g. **crop.json**) JSON objects can be referenced at mulitple places.

### Default values
Most of the JSON object data which might be included from database or from a file support an optional **key** names **DEFAULT** which enables the user to load/include data, but overwrite some of them manually. In the example below an EnvironmentParameters JSON object is being defined. It will be initialized completely from a file, but the keys **LeachingDepth** and **WindSpeedHeight** will be overwritten. That way a user could keep rarely changing data in a file and include them always via **DEFAULT** and from project to project just change update a few values.

```
"EnvironmentParameters": {
  "DEFAULT": ["include-from-file", "../monica-parameters/user-parameters/hermes-environment.json"],
  "LeachingDepth": 2.0,
  "WindSpeedHeight": 2.5
}
```

## Functions

Right now there exists a single mechanism to add some dynamics to the otherwise static configuration files. In the value place of a key/value pair can appear a **JSON array** which starts with a **string/text value**. In that case upon reading and interpreting the configuration file, MONICA will check internally if there's a **function** with a name corresponding to the string value, and if so interprets the whole JSON array as a function call. The first argument depicts the function being called, the rest of the array's elements depict the arguments to this function (same principle as function calls in LISP style programming languages). The result of this "function call" will be again a **JSON value** (e.g. **JSON object**) and replace the JSON array. If for some reason (e.g. wrong spelling, typo, whatever) no internal function is being found, the JSON array stays the way it is; this also being the reason for the lisp style syntax, to retain a valid **JSON document**.

### include data from a SQLite database
The following example taken from the **crop.json** configuration file, shows how to include data from a SQLite database. Right now there's a restricted set of data which can be included. The first parameter to the "include-from-db" function denotes the kind of data to fetch (in most cases a table). This can be thought of as a selector to another function, while the arrays other values a the parameters to that specific function. In case of the **crop** function, the next two arguments are the name of the **species** (**rye**) and **cultivar** (**winter rye**)  to include. In the case of the **crop_residue** "sub"-function, **rye** would be the species' crop residues and the other (here **empty ""**) argument the residue type (could also be for instance **cover** for just the rye's cover residues).

```
"cropParams": ["include-from-db", "crop", "rye", "winter rye"],
"residueParams": ["include-from-db", "crop_residue", "rye", ""]
```

Right now there are the following possible functions fetching data from the database <br> (e.g. syntax **["include-from-db" ...]**)

|  what | parameter 1 (example) | parameter 2 (example) | description |
| :----- | :----------- | :----------- | :----------- |
| "mineral_fertiliser" | fertiliser name (**"AN"**) | - | include mineral fertiliser parameters |
| "organic_fertiliser" | fertiliser name (**"CADLM"**) | - | include organic fertiliser |
| "crop_residue" | species name (**"rye"**) | residue_type (**"" or "cover"**) | include crop residue parameters |
| "species" | species name (**"rye"**) | - | include just the species parameters |
| "cultivar" | species name (**"rye"**) | cultivar name (**"winter rye"**) | include just the specified cultivars parameters (**Note:** a cultivar is only specifiable with the species as first parameter) |
| "crop" | species name (**"rye"**) | cultivar name (**"winter rye"**) | include both parts of the crop parameters in one JSON object (as usually needed and is equivalent to ```{"species": ["include-from-db", "species", ...], "cultivar": ["include-from-db", "cultivar", ..., ...]```) |
| "soil-temperature-params" | name of parameterset (**hermes or eva2 or macsur**) | - | include user definable global soil temperature parameters for the MONICA model |
| "environment-params" | name of parameterset (**hermes**) | - | include global user environment parameters |
| "soil-organic-params" | name of parameterset (**eva2**) | - | include global user soil organic parameters |
| "soil-transport-params" | name of parameterset (**macsur**) | - | include global user soil transport parameters |
| "soil-moisture-params" | name of parameterset (**hermes**) | - | include global user 
| "crop-params" | name of parameterset (**hermes**) | - | include global user crop parameters |

### include data from a file
To include data from a file the example from above would look like the example below. The name of the function is **include-from-file** with it's only parameter the path to the file to include. The whole contents of the named file should be **valid JSON** and will be included. The included JSON data may again contain other functions.

```
"cropParams": {
  "species": ["include-from-file", "../monica-parameters/crops/rye.json"],
  "cultivar": ["include-from-file", "../monica-parameters/crops/rye/winter rye.json"]
},
"residueParams": ["include-from-file", "../monica-parameters/crop-residues/rye.json"]
```

### reference data within a file
In **crop.json** it is desirable to be able to define a crop and reference it multiple times. This is what the **ref** function does. In the example below, taken from the **worksteps** section of a crop, the **Seed** workstep is amongst other values being defined by the key/value pair **crop: winter rye**. The references function takes two parameters, the first being a name (**"crops"**) which is a **key** in top-level JSON object in the file which contains another JSON object whose **key = WR** returns the JSON object to replace the function call. Thus in the example **crop.json** exists under the key **crops** a mapping (a JSON object) of arbitrary crop name shortcuts to crop parameter objects. Usually the objects themselves are being included by **include-from-db** or **include-from-file** functions.

```
{ "date": "1991-09-23", "type": "Seed", "crop": ["ref", "crops", "WR"] },
```

### other functions

| function name | parameter 1 (example) | parameter 2 (example) | description |
| :------------ | :-------------------- | :-------------------- | :---------- |
| "humus_st2corg" | humus class (**1**) | - | converts the humus class to corg value |
| "ld_eff2trd" | effective bulk density class (**1 - 5**) | clay content (**0.0 - 1.0**) | converts the effective bulk density given the clay content to raw density | 
| "KA5TextureClass2clay" | KA5 texture class (**fSms**) | - | returns the average clay content given the KA5 texture class |
| "KA5TextureClass2sand" |  KA5 texture class (**Lt3**) | - | returns the average sand content given the KA5 texture class |
| "sandAndClay2lambda" | sand content (**0.0 - 1.0**) | clay content (**0.0 - 1.0**) | calculates the lambda value given sand and clay content |

As can be seen from the following examples taken from **site.json**, the function calls are allowed to be nested.

```
"SoilRawDensity": ["ld_eff2trd", 2, ["KA5TextureClass2clay", "Sl2"]],
"Lambda": ["sandAndClay2lambda", ["KA5TextureClass2sand", "Sl2"], ["KA5TextureClass2clay", "Sl2"]]
```


## JSON data format
Currently MONICA uses  [**JSON**](http://www.json.org) as format for it's files. Thus care has to be taken to obey the JSON rules, don't forget commas and the like. In order to check and/or reformat existing code, tools like [this online json viewer](http://codebeautify.org/jsonviewer) can be used.

## **sim.json**
The **sim.json** file contains simulation specific information like start and end date (MONICA will pick the right climate data from **climate.csv**) or whether certain global toggles like nitrogen response/use of secondary yields will be turned on or of. 

**NumberOfLayers** and **LayerThickness** shouldn't be changed currently.

```
{
  "startDate": "1991-01-01",
  "endDate": "1997-12-31",
  
  "NumberOfLayers": 20,
  "LayerThickness": [0.1, "m"],
  
  "UseSecondaryYields": true,
  "NitrogenResponseOn": true,
  "WaterDeficitResponseOn": true,
  "EmergenceMoistureControlOn": true,
  "EmergenceFloodingControlOn": true,
    
  "UseAutomaticIrrigation": false,  
  "AutoIrrigationParams": {
    "irrigationParameters": {
      "nitrateConcentration": [0, "mg dm-3"],
      "sulfateConcentration": [0, "mg dm-3"]
    },
    "amount": [17, "mm"],
    "threshold": 0.35
  },  
  
  "UseNMinMineralFertilisingMethod": false,
  "NMinUserParams": { "min": 0, "max": 0, "delayInDays": 0 },
  "NMinFertiliserPartition": {
    "id": "my AN",
    "name": "my very own ammonium nitrate variant",
    "Carbamid": 0,
    "NH4": 0,
    "NO3": 0
  }
}

```


### **site.json**
**site.json** holds all input data and parameters which could be considers site specific. Besides the key **SiteParameters** in the top-level JSON object, there might be a few JSON objects which set global/general soil and environment specific parameters. These can either be included from the SQLite database (table user_parameter) or the filesystem or be defined directly in **site.json**.  In order to facilitate easy overwriting of the standard parameters, they are included via the **DEFAULT** parameter pseudo-key. 

```
{
  "SiteParameters": {
    "Latitude": 52.80939865112305,
    "Slope": 0,
    "HeightNN": [0 , "m"],
    "NDeposition": 30,
    "SoilProfileParameters": [
      {
        "Thickness": 0.3,
        "SoilOrganicCarbon": [0.8, "%"],
        "KA5TextureClass": "Sl2",
        "SoilRawDensity": ["ld_eff2trd", 2, ["KA5TextureClass2clay", "Sl2"]],
        "Lambda": ["sandAndClay2lambda", ["KA5TextureClass2sand", "Sl2"], ["KA5TextureClass2clay", "Sl2"]]
      },
      {
        "Thickness": 0.1,
        "SoilOrganicCarbon": [0.15, "%"],
        "KA5TextureClass": "Sl2",
        "SoilRawDensity": ["ld_eff2trd", 2, ["KA5TextureClass2clay", "Sl2"]]
      },
      {
        "Thickness": 1.6,
        "SoilOrganicCarbon": [0.05, "%"],
        "KA5TextureClass": "Sl2",
        "SoilRawDensity": ["ld_eff2trd", 2, ["KA5TextureClass2clay", "Sl2"]]
      }
    ]
  },
  "SoilTemperatureParameters": ["include-from-file", "../monica-parameters/user-parameters/hermes-soil-temperature.json"],
  "EnvironmentParameters": {
    "DEFAULT": ["include-from-file", "../monica-parameters/user-parameters/hermes-environment.json"],
    "LeachingDepth": 2.0,
    "WindSpeedHeight": 2.5
  },
  "SoilOrganicParameters": ["include-from-file", "../monica-parameters/user-parameters/hermes-soil-organic.json"],
  "SoilTransportParameters": ["include-from-file", "../monica-parameters/user-parameters/hermes-soil-transport.json"],
  "SoilMoistureParameters": ["include-from-file", "../monica-parameters/user-parameters/hermes-soil-moisture.json"]
}

```

### **crop.json**
**crop.json** defines all crop specific input data for MONICA. There has to be just one key in the top-level JSON object, **cropRotation**. **cropRotation** is a JSON array (list) of JSON objects representing a cultivation method (class CultivationMethod in MONICA code). A cultivation method is defined as a set of work steps (class hierarchy WorkStep in MONICA code). Work steps can be the seeding of a crop, the harvesting thereof, fertilizer, irrigation water or tillage applications. A seeding application tells MONICA at which point in time which crop to grow. Within the seeding work step a key **crop** will be set to a JSON object with crop parameters. This can be done in-line, via a include function (**include-from-db** or **include-from-file**) or via a **ref** function. Because crops might be used in more than one work step or cultivation method and the example below defines all used crops in a JSON object, which maps shortcut names to the actual crop parameters. The mapping object is available under the top-level key **crops** which is the first parameter to the **ref** function, the second being the referenced shortcut names. The names chosen (**crops** and e.g. **WR** or **SM**) are abitrary and might depend on the use case.

The example below sports another key **CropParameters**, which contains the some global crop parameters common to all crops, either from the **user-parameter** database table or a referenced file.

```
{
  "crops": {
    "WR": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/rye.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/rye/winter rye.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/rye.json"]
    },
    "SM": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/maize.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/maize/silage maize.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/maize.json"]
    },
    "MEP": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/potato.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/potato/moderately early potato.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/potato.json"]
    },
    "WW": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/wheat.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/wheat/winter wheat.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/wheat.json"]
    },
    "WG": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/barley.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/barley/winter barley.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/barley.json"]
    },
    "SG": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/barley.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/barley/spring barley.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/barley.json"]
    },
    "SC": { 
      "cropParams": {
        "species": ["include-from-file", "../monica-parameters/crops/rape.json"],
        "cultivar": ["include-from-file", "../monica-parameters/crops/rape/winter rape.json"]
      },
      "residueParams": ["include-from-file", "../monica-parameters/crop-residues/rape.json"]
    }
  },
  
  "cropRotation": [
    {
      "worksteps": [
        { "date": "1991-09-23", "type": "Seed", "crop": ["ref", "crops", "WR"] },
        { 
          "date": "1992-05-05", 
          "type": "IrrigationApplication", 
          "amount": [1.0, "mm"],
          "parameters": { 
            "nitrateConcentration": [0.0, "mg dm-3"], 
            "sulfateConcentration": [334, "mg dm-3"] 
          }
        },
        { 
          "date": "1992-04-03", 
          "type": "MineralFertiliserApplication", 
          "amount": [40.0, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { 
          "date": "1992-05-07", 
          "type": "MineralFertiliserApplication", 
          "amount": [40.0, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1992-07-27", "type": "Harvest", "crop": ["ref", "crops", "WR"] }
      ]
    },
    {
      "worksteps": [
        { 
          "date": "1993-04-23", 
          "type": "MineralFertiliserApplication", 
          "amount": [125, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1993-04-27", "type": "TillageApplication", "depth": [0.15, "m"] },
        { "date": "1993-05-04", "type": "Seed", "crop": ["ref", "crops", "SM"] },
        { 
          "date": "1993-05-10", 
          "type": "MineralFertiliserApplication", 
          "amount": [60, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1993-09-23", "type": "Harvest", "crop": ["ref", "crops", "SM"] },
        { 
          "date": "1993-12-16", 
          "type": "OrganicFertiliserApplication", 
          "amount": [30000, "kg N"], 
          "parameters": ["include-from-file", "../monica-parameters/organic-fertilisers/CADLM.json"],
          "incorporation": true
        },
        { "date": "1993-12-22", "type": "TillageApplication", "depth": [0.1, "m"] }
      ]
    },
    {
      "worksteps": [
        { "date": "1994-04-25", "type": "Seed", "crop": ["ref", "crops", "MEP"] },
        { 
          "date": "1994-05-04", 
          "type": "MineralFertiliserApplication", 
          "amount": [90, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1994-09-06", "type": "Harvest", "crop": ["ref", "crops", "MEP"] },
        { "date": "1994-09-29", "type": "TillageApplication", "depth": [0.15, "m"] }
      ]
    },
    {
      "worksteps": [
        { "date": "1994-10-11", "type": "Seed", "crop": ["ref", "crops", "WW"] },
        { 
          "date": "1995-03-24", 
          "type": "MineralFertiliserApplication", 
          "amount": [60, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { 
          "date": "1995-04-27", 
          "type": "MineralFertiliserApplication", 
          "amount": [40, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { 
          "date": "1995-05-12", 
          "type": "MineralFertiliserApplication", 
          "amount": [60, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1995-08-02", "type": "Harvest", "crop": ["ref", "crops", "WW"] },
        { "date": "1995-08-03", "type": "TillageApplication", "depth": [0.15, "m"] }
      ]
    },
    {
      "worksteps": [
        { "date": "1995-09-07", "type": "Seed", "crop": ["ref", "crops", "WG"] },
        { 
          "date": "1996-03-21", 
          "type": "MineralFertiliserApplication", 
          "amount": [60, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1996-04-13", "type": "Harvest", "crop": ["ref", "crops", "WG"] },
        { "date": "1996-04-14", "type": "TillageApplication", "depth": [0.10, "m"] }
      ]
    },
    {
      "worksteps": [
        { "date": "1996-04-17", "type": "Seed", "crop": ["ref", "crops", "SG"] },
        { "date": "1996-09-10", "type": "Harvest", "crop": ["ref", "crops", "SG"] },
        { "date": "1996-09-17", "type": "TillageApplication", "depth": [0.10, "m"] }
      ]
    },
    {
      "worksteps": [
        { "date": "1997-04-04", "type": "Seed", "crop": ["ref", "crops", "SC"] },
        { 
          "date": "1997-04-10", 
          "type": "MineralFertiliserApplication", 
          "amount": [80, "kg N"], 
          "partition": ["include-from-file", "../monica-parameters/mineral-fertilisers/AN.json"]
        },
        { "date": "1997-07-08", "type": "Harvest", "crop": ["ref", "crops", "SC"] },
        { "date": "1997-07-09", "type": "TillageApplication", "depth": [0.10, "m"] }
      ]
    }
  ],
  
  "CropParameters": {
    "DEFAULT": ["include-from-file", "../monica-parameters/user-parameters/hermes-crop.json"]
  }
}
```





